<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Model Playground</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v4.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://rawgit.com/protyze/aframe-curve-component/master/dist/aframe-curve-component.min.js"></script>
  <script src="https://rawgit.com/protyze/aframe-alongpath-component/master/dist/aframe-alongpath-component.min.js"></script>
    <script src="https://unpkg.com/aframe-render-order-component@1.1.0/dist/aframe-render-order-component.min.js"></script>
    <script type="text/javascript" src="../../index.js"></script>
    <script type="text/javascript" src="../../tour.js"></script>
    <script type="text/javascript" src="../../controller.js"></script>
    <script type="text/javascript" src="../../lookat.js"></script>
    <script type="text/javascript" src="../../override-tycho-hue-material.js"></script>
    <script type="text/javascript" src="../../override-tycho-halo-material.js"></script>
    <script type="text/javascript" src="makeTour.js"></script>
  </head>
  <body>
    <a-scene id="mainScene"
             background="color: #FAFAFA"
             stats
             render-order="background, nebula, clouds"
             >
    	<a-assets> <!-- add the gltf models here -->
        <img id="deepspace" src="../../deepspace.png">
        <a-asset-item id="tycho" src="../../gltf/tycho_v2.glb"></a-asset-item>
        <a-asset-item id="tychoHaloGltf" src="../../gltf/tycho_halo_v1.glb"></a-asset-item>
        <img id="glow" src="../../textures/glow1.png">
        <audio id="audio1" src="./audio/Tycho_VR_3DObjectIntro.ogg" preload="auto"></audio>
        <audio id="audio2" src="./audio/Tycho_VR_Shockwave.ogg" preload="auto"></audio>
        <audio id="audio3" src="./audio/Tycho_VR_StellarDebris.ogg" preload="auto"></audio>
        <audio id="audio4" src="./audio/Tycho_VR_DebrisClumpsShockArcs.ogg" preload="auto"></audio>
        <audio id="audio5" src="./audio/Tycho_VR_NoCentralPointSource.ogg" preload="auto"></audio>
    	</a-assets>

      <a-sky src="#deepspace" render-order="background"></a-sky>

      <a-entity id="textHolder"
                    position="0 0 0"
                    look-at="[camera]"
                    opacity="0.9"
                    text="width: 1; color: white; align: center;
                          anchor: center; side: double;
                          value: ">
        </a-entity>

      <a-entity id="rig" rotation="0 0 0" position="0 0 0" wasd-controls look-controls="pointerLockEnabled: true" alongpath>
        <a-entity id="camera" camera="active: true" position="0 0 0"></a-entity>
      </a-entity>

      <a-entity id="tour-controller"></a-entity>

      <a-entity
        id="glowingNebula"
        scale="0.5 0.5 0.5"
        position="0 0 0"
        rotation="0 0 0">
        <a-entity
          gltf-model="#tycho"
          id="tycho_model"
          override-tycho-material="noiseAmt: 0.0;"
          render-order="nebula"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
        <a-entity 
          gltf-model="#tychoHaloGltf"
          scale="0.95 0.95 0.95"
          id="tycho_halo"
          render-order="clouds"
          override-tycho-halo-material
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>

      </a-entity>        

    </a-scene>

    <script>
      let tourURL = 'tychoTour.json';

    fetch(tourURL)
      .then(response => response.json())
      .then(json => loadTour(json));

    let loadTour = (json) => {
      const stops = json["stops"]

      var sceneEl = document.querySelector('a-scene');
      
      // add the parent controller entity
      // var controllerEl = sceneEl.querySelector('#tour-controller');
      var controllerEl = document.getElementById('tour-controller');
      // var controllerEl = document.createElement('a-entity');

      // add a curve entity for each stop, and set its attributes 
      for (const stopKey in stops) {
        const stopValues = stops[stopKey];

        var curveEl = document.createElement('a-curve');
        const stopAttrs = stopValues["attributes"];
        
        for (const key in stopAttrs) {
          curveEl.setAttribute(key, stopAttrs[key]);
        }

        // add in the curve points for the current stop 
        var curvePts = stopValues["curvePoints"];
        
        for (const value of curvePts ) {
          var curvePtEl = document.createElement('a-curve-point');
          curvePtEl.setAttribute('position', value);
          curveEl.appendChild(curvePtEl);
        }
        controllerEl.appendChild(curveEl);
      }

      // sceneEl.appendChild(controllerEl);
      controllerEl.setAttribute("sound", "volume", "0.75");
      controllerEl.setAttribute('controller', '');
      console.log("appended controller to scene");
    }

    console.log("should be done?");
    </script>
  </body>
</html>